---
title: "ExploratoryAnalyses"
author: "MRB"
date: "October 27, 2017"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

## Purpose
Document for data exploration for __Data Challenge 2017__!

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#read in neccessary packages

ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
}

packages <- c("GGally", "tidyverse", "caret", "glmnet", "arsenal", "rpart")

ipak(packages)

#read in dataset

dc <- read_csv("Data.csv")

##EVALUATE THE STRUCTURE OF THE DATA

dim(dc)
names(dc)
str(dc)

# variable x1 operates the same as ID. Will keep ID.

dc1 <- dc %>% 
  dplyr::select(-X1)
```

# Look at the data

```{r tab1, include = TRUE, echo=FALSE, results='asis'}

## CREATE A SUMMARY TABLE
#change the treatment from integer to character so the desired information is expressed in the summary table

class(dc1$A) <- "character"
class(dc1$W5) <- "character"
class(dc1$W6) <- "character"

tab1 <- dc1 %>% 
  dplyr::select(-ID) %>% 
  tableby(formula = ~ .)

summary(tab1, title = "Overall Data Summary")
```


```{r spm1, include = TRUE, fig.align="center", cache=TRUE, echo=FALSE}

## CREATE A SCATTERPLOT MATRIX

# ID has no bearing on the modeling. will exclude from evaluation.

sp1 <- dc1 %>% 
  dplyr::select(-ID) %>% 
  ggpairs()

# sp1
# ggsave("sp1.png", device = "png", plot = last_plot(), width = 15, height = 15, unit = "in")
# unlink("sp1.png") do not run this

# Y is skewed right and strictly positive. will try log transform to see what it looks like.

sp2 <- dc1 %>% 
  mutate(log_y = log(Y)) %>% 
  dplyr::select(-ID, -Y) %>%
  dplyr::select(log_y,everything()) %>% 
  ggpairs()

# sp2
# ggsave("sp2.png", device = "png", plot = last_plot(), width = 15, height = 15, unit = "in")
```
Scatterplot Matrix without Transformation

![knit to html to see](sp1.png)
Scatterplot Matrix with log transform on response variable. 

![knit to html to see](sp2.png)

```{r, model1, include=TRUE, echo=FALSE, results='asis'}

mod1 <- modelsum(data = dc1, formula = formulize("Y", names(dc1)[4:28]), adjust = ~ A, family = "gaussian")
summary(mod1, title = "Model Summaries: Y = W_i + A, for i = 1, 2, ..., 25")
```

# Playtime!

```{r treeeeeeeees, include = TRUE, echo = FALSE}

# Binary Decision Tree
# First look at "Variable Importance"

tree1 <- rpart(data = dc1, formula = formulize("Y", c(names(dc1)[4:28], "A")))

summary(tree1) #Look at variable importance for funs
plot(tree1)
text(tree1)
title("Everybody Loves Raymond")
```

From the scatterplot matrix there appears to be several variables that are very strongly correlated.
Techniques to consider: lasso, pls, others?

Of the variables that are highly correlated, can select the variable(s) that appear to be most correlated with the response

Must not lose focus. The objective is to measure the treatment effect of A, not predict Y.

```{r lasso, inclue = TRUE, echo = FALSE}
#LASSO requires that trainX is a data.frame, trainY is numeric, character variables be provided as dummy variables, and numeric variables be centered and scaled

dc1 <- dc1 %>% 
  dplyr::select(-ID) %>% 
  as.data.frame()

dummies <- dummyVars(Y ~., data = dc1)
dummies2 <- as.data.frame(predict(dummies, newdata = dc1))

dc2 <- as.data.frame(cbind(dc1$Y, dummies2))
names(dc2)[1] <- "Y"

set.seed(1)

inTrain <- createDataPartition(dc2$Y, p = .75, list = FALSE)

training<-dc2[inTrain,]
testing<-dc2[-inTrain,]
dim(training)

trainY <- training$Y

trainX <- training %>% 
  dplyr::select(-Y)

testY <- testing %>% 
  dplyr::select(Y)

testX <- testing %>% 
  dplyr::select(-Y)

rctrl1 <- trainControl(method = "cv", number = 3, returnResamp = "all")
rctrl2 <- trainControl(method = "LOOCV")
rctrl3 <- trainControl(method = "none")
rctrlR <- trainControl(method = "cv", number = 3, returnResamp = "all", search = "random")

set.seed(8675309)

test_reg_cv_model <- train(trainX, trainY, method = "lasso", trControl = rctrl1, preProc = c("center", "scale"))

test_reg_pred <- predict(test_reg_cv_model, testX)
```